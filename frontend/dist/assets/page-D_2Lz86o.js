import{r as t,u as oe,j as e,R as p,C as m,a as h,m as u}from"./index-g8JsAD6D.js";import{P as U}from"./PageTitle-CxfJYhSt.js";import{R as _,S as ce}from"./ProtectedRoute-D3CIokNI.js";import{C as r}from"./Card-BeXcCZYv.js";import{T as x}from"./Tab-C-Xprgvi.js";import{N as d}from"./TabPane-CZwkq4WG.js";import{B as le}from"./Button-D0PIrq1X.js";import{F as c}from"./Form-D1-JPNIV.js";import{T as de}from"./Table-D3ZYodCp.js";import{B as me}from"./Badge-CntnA0Ph.js";import"./divWithClassName-DiLhEsAW.js";import"./hook-DXU0U8PY.js";import"./extends-CF3RwP-h.js";import"./Nav-C2Ycspzm.js";import"./DataKey-COGXBUcQ.js";import"./NavContext-Di37ZEQq.js";import"./Button-gQG5sY8T.js";import"./NavbarContext-D9GUF_xH.js";import"./Anchor-B7CPyDu2.js";import"./NoopTransition-Zj_9YN3c.js";import"./FormCheck-VkeX_5_i.js";import"./Feedback-DRxK_Gi1.js";import"./FormContext-pFRdsTk3.js";import"./ElementChildren-Dnw0Ivgz.js";import"./FormControl-DPlcBO7X.js";import"./FormGroup-B98vKDZp.js";import"./FormLabel-B437T1BD.js";import"./FormSelect-BKoOn0HX.js";import"./FormText-e0bnF0FN.js";const Me=()=>{const[B,H]=t.useState([]),[o,F]=t.useState(null),[j,T]=t.useState([]),[E,$]=t.useState([]),[z,K]=t.useState([]),[L,I]=t.useState([]),[M,g]=t.useState(!0),[y,S]=t.useState(!1),[he,O]=t.useState([]),[v,f]=t.useState([]),[q,G]=t.useState([]),[b,C]=t.useState(""),[xe,Y]=t.useState([]),[N,R]=t.useState([]),[P,A]=t.useState([]),[J,Q]=t.useState("users"),{showNotification:k}=oe(),V=async()=>{try{const s=await u.getUsers({page:1,limit:100});H(s.data)}catch(s){console.error("Failed to load users:",s)}},W=async()=>{try{const s=await h.getPermissions();T(s.data)}catch(s){console.error("Failed to load permissions:",s)}},X=async()=>{try{const s=await h.getRoles();$(s.data)}catch(s){console.error("Failed to load roles:",s)}},Z=async()=>{try{const s=await u.getDepartments({page:1,limit:100});K(s.data)}catch(s){console.error("Failed to load departments:",s)}},ee=async()=>{try{const s=await u.getSections({page:1,limit:100});I(s.data)}catch(s){console.error("Failed to load sections:",s)}},se=async s=>{var a,i;try{const n=(await h.getUserAccess(s)).data.access,ie=[...n.permsExtra||[],...(n.roles||[]).flatMap(l=>{const D=E.find(ne=>ne.key===l);return D?D.permissions:[]})];O(n.roles||[]),f([...new Set(ie)]),G(n.permsDenied||[]),C(n.homeRoute||""),Y(n.pageAccess||[]),R(((a=n.departmentRestrictions)==null?void 0:a.map(l=>l._id))||[]),A(((i=n.sectionRestrictions)==null?void 0:i.map(l=>l._id))||[])}catch(w){console.error("Failed to load user access:",w)}},te=s=>{F(s),se(s._id)},re=async()=>{if(o)try{S(!0);const s={roles:[],permsExtra:v,permsDenied:q,homeRoute:b||void 0,pageAccess:[],departmentRestrictions:N,sectionRestrictions:P};await h.updateUserAccess(o._id,s),k({message:"User access updated successfully",variant:"success"})}catch(s){k({message:s.message,variant:"danger"})}finally{S(!1)}},ae=s=>{f(a=>a.includes(s)?a.filter(i=>i!==s):[...a,s])};return t.useEffect(()=>{(async()=>{g(!0),await Promise.all([V(),W(),X(),Z(),ee()]),g(!1)})()},[]),M?e.jsxs(_,{perm:"management.permissions",children:[e.jsx(U,{title:"Access Control"}),e.jsx("div",{className:"text-center py-5",children:e.jsx(ce,{animation:"border"})})]}):e.jsxs(_,{perm:"management.permissions",children:[e.jsx(U,{title:"Access Control"}),e.jsx("div",{className:"container-fluid",children:e.jsx(p,{children:e.jsx(m,{children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h4",{className:"card-title mb-0",children:"Access Control & Permissions"})}),e.jsx(r.Body,{children:e.jsxs(x.Container,{activeKey:J,onSelect:Q,children:[e.jsxs(d,{variant:"tabs",className:"mb-3",children:[e.jsx(d.Item,{children:e.jsx(d.Link,{eventKey:"users",children:"User Access"})}),e.jsx(d.Item,{children:e.jsx(d.Link,{eventKey:"registry",children:"Permission Registry"})})]}),e.jsxs(x.Content,{children:[e.jsx(x.Pane,{eventKey:"users",children:e.jsxs(p,{children:[e.jsx(m,{md:4,children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h6",{className:"mb-0",children:"Select User"})}),e.jsx(r.Body,{className:"p-0",style:{maxHeight:"400px",overflowY:"auto"},children:B.map(s=>e.jsxs("div",{className:`p-3 border-bottom cursor-pointer ${(o==null?void 0:o._id)===s._id?"bg-light":""}`,onClick:()=>te(s),style:{cursor:"pointer"},children:[e.jsx("strong",{children:s.username}),e.jsx("div",{className:"text-muted small",children:s.email})]},s._id))})]})}),e.jsx(m,{md:8,children:o?e.jsxs(r,{children:[e.jsxs(r.Header,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h6",{className:"mb-0",children:"Access Configuration"}),e.jsx("small",{className:"text-muted",children:o.username})]}),e.jsx(le,{variant:"primary",size:"sm",onClick:re,disabled:y,children:y?"Saving...":"Save Changes"})]}),e.jsx(r.Body,{children:e.jsx(p,{children:e.jsxs(m,{children:[e.jsx("h6",{children:"Page Access Permissions"}),e.jsx("p",{className:"text-muted small",children:"Select individual pages this user can access"}),j.map(s=>e.jsx(c.Check,{type:"checkbox",id:`perm-${s.key}`,label:`${s.label} ${s.group?`(${s.group})`:""}`,checked:v.includes(s.key),onChange:()=>ae(s.key),className:"mb-2"},s.key)),e.jsx("h6",{className:"mt-3",children:"Home Route"}),e.jsx(c.Control,{type:"text",placeholder:"e.g., /dashboard/admin",value:b,onChange:s=>C(s.target.value),size:"sm"}),e.jsx("h6",{className:"mt-3",children:"Department Restrictions"}),e.jsx(c.Select,{size:"sm",multiple:!0,value:N,onChange:s=>{const a=Array.from(s.target.selectedOptions,i=>i.value);R(a)},children:z.map(s=>e.jsx("option",{value:s._id,children:s.name},s._id))}),e.jsx(c.Text,{className:"text-muted",children:"Hold Ctrl/Cmd to select multiple departments"}),e.jsx("h6",{className:"mt-3",children:"Section Restrictions"}),e.jsx(c.Select,{size:"sm",multiple:!0,value:P,onChange:s=>{const a=Array.from(s.target.selectedOptions,i=>i.value);A(a)},children:L.map(s=>{var a;return e.jsxs("option",{value:s._id,children:[(a=s.departmentId)==null?void 0:a.name," - ",s.name]},s._id)})}),e.jsx(c.Text,{className:"text-muted",children:"Hold Ctrl/Cmd to select multiple sections"})]})})})]}):e.jsx(r,{children:e.jsxs(r.Body,{className:"text-center py-5",children:[e.jsx("h5",{children:"Select a User"}),e.jsx("p",{className:"text-muted",children:"Choose a user to manage their permissions"})]})})})]})}),e.jsx(x.Pane,{eventKey:"registry",children:e.jsxs(r,{children:[e.jsx(r.Header,{children:e.jsx("h6",{className:"mb-0",children:"Permission Registry"})}),e.jsx(r.Body,{children:e.jsxs(de,{responsive:!0,hover:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Permission Key"}),e.jsx("th",{children:"Label"}),e.jsx("th",{children:"Group"})]})}),e.jsx("tbody",{children:j.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("code",{children:s.key})}),e.jsx("td",{children:s.label}),e.jsx("td",{children:s.group&&e.jsx(me,{bg:"secondary",children:s.group})})]},s.key))})]})})]})})]})]})})]})})})})]})};export{Me as default};
