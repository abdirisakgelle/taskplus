import{g as D,u as z,e as M,r,j as e,R as $,C as L,m as q,s as u}from"./index-g8JsAD6D.js";import{S as g}from"./sweetalert2.all-BNJhgLm2.js";import{P as F}from"./PageTitle-CxfJYhSt.js";import{C as w}from"./Card-BeXcCZYv.js";import{T as Q}from"./Tabs-Cgvpg8I9.js";import{T as N}from"./Tab-C-Xprgvi.js";import{B as o}from"./Badge-CntnA0Ph.js";import{B as S}from"./Button-D0PIrq1X.js";import"./divWithClassName-DiLhEsAW.js";import"./hook-DXU0U8PY.js";import"./extends-CF3RwP-h.js";import"./TabPane-CZwkq4WG.js";import"./Nav-C2Ycspzm.js";import"./DataKey-COGXBUcQ.js";import"./NavContext-Di37ZEQq.js";import"./Button-gQG5sY8T.js";import"./NavbarContext-D9GUF_xH.js";import"./Anchor-B7CPyDu2.js";import"./NoopTransition-Zj_9YN3c.js";import"./ElementChildren-Dnw0Ivgz.js";const de=()=>{D();const{showNotification:c}=z(),{user:_}=M(),[p,k]=r.useState("stuck"),[j,C]=r.useState([]),[v,R]=r.useState([]),[f,h]=r.useState(!0),[K,A]=r.useState(new Map),[a,m]=r.useState({page:1,pageSize:20,total:0,pages:0});r.useEffect(()=>{(async()=>{try{const t=await q.getEmployees({pageSize:1e3}),i=new Map;t.data.forEach(l=>{i.set(l.employee_id,l.name)}),A(i)}catch(t){console.error("Failed to load employees:",t)}})()},[]);const y=async()=>{try{h(!0);const s=await u.getTickets({stuck:!0,page:a.page,pageSize:a.pageSize});C(s.data||[]),m(t=>({...t,total:s.meta.total,pages:s.meta.pages}))}catch(s){c({message:s.message||"Failed to load stuck tickets",variant:"danger"})}finally{h(!1)}},b=async()=>{try{h(!0);const s=await u.getReviews({page:a.page,pageSize:a.pageSize});R(s.data||[]),m(t=>({...t,total:s.meta.total,pages:s.meta.pages}))}catch(s){c({message:s.message||"Failed to load reviews",variant:"danger"})}finally{h(!1)}};r.useEffect(()=>{p==="stuck"?y():b()},[p,a.page]);const x=s=>{m(t=>({...t,page:s}))},B=async s=>{const t=await g.fire({title:"Add QA note",html:`
        <div class="text-start">
          <label class="form-label">Issue Status</label>
          <select id="swal-status" class="form-select mb-3">
            <option value="">Select status...</option>
            <option value="Needs escalation">Needs escalation</option>
            <option value="Agent needs training">Agent needs training</option>
            <option value="Process issue">Process issue</option>
            <option value="Resolved properly">Resolved properly</option>
            <option value="Requires follow-up">Requires follow-up</option>
          </select>
          <label class="form-label">Resolved</label>
          <select id="swal-resolved" class="form-select mb-3">
            <option value="false">No</option>
            <option value="true">Yes</option>
          </select>
          <label class="form-label">Notes</label>
          <textarea id="swal-notes" class="form-control" rows="4" placeholder="Add your QA notes..."></textarea>
        </div>
      `,showCancelButton:!0,confirmButtonText:"Save Review",cancelButtonText:"Cancel",confirmButtonColor:"#0d6efd",cancelButtonColor:"#6c757d",preConfirm:()=>{const i=document.getElementById("swal-status").value,l=document.getElementById("swal-resolved").value==="true",n=document.getElementById("swal-notes").value;return(!i||!n)&&g.showValidationMessage("Please fill all required fields"),{status:i,resolved:l,notes:n}}});if(t.isConfirmed)try{await u.createReview({ticket_id:s.ticket_id,reviewer_id:_.employeeId,issue_status:t.value.status,resolved:t.value.resolved,notes:t.value.notes}),c({message:"Saved successfully.",variant:"success"}),p==="reviews"&&b()}catch(i){c({message:i.message,variant:"danger"})}},T=async s=>{if((await g.fire({title:"Resolve after QA?",text:"This will mark the ticket as reviewed and resolved.",icon:"question",showCancelButton:!0,confirmButtonText:"Resolve",cancelButtonText:"Cancel",confirmButtonColor:"#28a745",cancelButtonColor:"#6c757d"})).isConfirmed)try{await u.updateTicket(s.ticket_id,{resolution_status:"Completed"}),c({message:"Saved successfully.",variant:"success"}),y()}catch(i){c({message:i.message,variant:"danger"})}},E=s=>{const t=new Date,i=new Date(s),l=t-i,n=Math.floor(l/(1e3*60*60)),d=Math.floor(n/24);return d>0?`${d}d ${n%24}h`:`${n}h`},I=s=>({Open:"warning",Closed:"success",Reopened:"danger"})[s]||"secondary",P=s=>({Pending:"secondary","In-Progress":"info",Completed:"success"})[s]||"secondary";return e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"Reviews (QA)",breadcrumbItems:[{label:"Customer Support",path:"/support/tickets",active:!1},{label:"Reviews",path:"/support/reviews",active:!0}]}),e.jsx($,{children:e.jsx(L,{xs:12,children:e.jsx(w,{children:e.jsxs(w.Body,{children:[e.jsxs(Q,{activeKey:p,onSelect:s=>{k(s),m(t=>({...t,page:1}))},className:"mb-3",children:[e.jsx(N,{eventKey:"stuck",title:`Stuck > 1h (${a.total})`,children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover table-nowrap mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Ticket ID"}),e.jsx("th",{children:"Age"}),e.jsx("th",{children:"Customer"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Issue Type"}),e.jsx("th",{children:"Agent"}),e.jsx("th",{children:"Last Update"}),e.jsx("th",{children:"State"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:f?e.jsx("tr",{children:e.jsx("td",{colSpan:"10",className:"text-center py-4",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})})}):j.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"10",className:"text-center py-4 text-muted",children:"No stuck tickets found"})}):j.map(s=>e.jsxs("tr",{children:[e.jsxs("td",{children:["#",s.ticket_id]}),e.jsx("td",{children:e.jsx(o,{bg:"danger",children:E(s.updatedAt)})}),e.jsxs("td",{children:[e.jsx("div",{children:s.customer_phone}),s.customer_location&&e.jsx("small",{className:"text-muted",children:s.customer_location})]}),e.jsx("td",{children:e.jsx(o,{bg:P(s.resolution_status),children:s.resolution_status})}),e.jsx("td",{children:e.jsx(o,{bg:"primary",className:"bg-opacity-10 text-primary",children:s.issue_category})}),e.jsx("td",{children:s.issue_type||"-"}),e.jsx("td",{children:s.agent_name||"Unassigned"}),e.jsx("td",{children:new Date(s.updatedAt).toLocaleString()}),e.jsx("td",{children:e.jsx(o,{bg:I(s.ticket_state),children:s.ticket_state})}),e.jsx("td",{children:e.jsxs("div",{className:"d-flex gap-1",children:[e.jsx(S,{size:"sm",variant:"primary",onClick:()=>B(s),title:"Add Review Note",children:e.jsx("i",{className:"mdi mdi-note-plus"})}),e.jsx(S,{size:"sm",variant:"success",onClick:()=>T(s),title:"Resolve",children:e.jsx("i",{className:"mdi mdi-check"})})]})})]},s.ticket_id))})]})})}),e.jsx(N,{eventKey:"reviews",title:"All Reviews",children:e.jsx("div",{className:"table-responsive",children:e.jsxs("table",{className:"table table-hover table-nowrap mb-0",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Review ID"}),e.jsx("th",{children:"Ticket ID"}),e.jsx("th",{children:"Customer"}),e.jsx("th",{children:"Category"}),e.jsx("th",{children:"Agent"}),e.jsx("th",{children:"Reviewer"}),e.jsx("th",{children:"Review Date"}),e.jsx("th",{children:"Issue Status"}),e.jsx("th",{children:"Resolved"}),e.jsx("th",{children:"Notes"})]})}),e.jsx("tbody",{children:f?e.jsx("tr",{children:e.jsx("td",{colSpan:"10",className:"text-center py-4",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})})}):v.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"10",className:"text-center py-4 text-muted",children:"No reviews found"})}):v.map(s=>{var t,i,l,n,d;return e.jsxs("tr",{children:[e.jsxs("td",{children:["#",s.review_id]}),e.jsx("td",{children:e.jsxs("a",{href:`/support/tickets?ticket_id=${s.ticket_id}`,children:["#",s.ticket_id]})}),e.jsx("td",{children:((t=s.ticket_info)==null?void 0:t.customer_phone)||"-"}),e.jsx("td",{children:(i=s.ticket_info)!=null&&i.issue_category?e.jsx(o,{bg:"primary",className:"bg-opacity-10 text-primary",children:s.ticket_info.issue_category}):"-"}),e.jsx("td",{children:((l=s.ticket_info)==null?void 0:l.agent_name)||"-"}),e.jsx("td",{children:s.reviewer_name||"-"}),e.jsx("td",{children:new Date(s.review_date).toLocaleDateString()}),e.jsx("td",{children:e.jsx(o,{bg:"info",className:"bg-opacity-10 text-info",children:s.issue_status})}),e.jsx("td",{children:s.resolved?e.jsx(o,{bg:"success",children:"Yes"}):e.jsx(o,{bg:"warning",children:"No"})}),e.jsx("td",{children:e.jsxs("span",{title:s.notes,children:[(n=s.notes)==null?void 0:n.substring(0,50),((d=s.notes)==null?void 0:d.length)>50&&"..."]})})]},s.review_id)})})]})})})]}),a.pages>1&&e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-3",children:[e.jsxs("div",{className:"text-muted",children:["Showing ",(a.page-1)*a.pageSize+1," to"," ",Math.min(a.page*a.pageSize,a.total)," of"," ",a.total," items"]}),e.jsx("nav",{children:e.jsxs("ul",{className:"pagination mb-0",children:[e.jsx("li",{className:`page-item ${a.page===1?"disabled":""}`,children:e.jsx("button",{className:"page-link",onClick:()=>x(a.page-1),disabled:a.page===1,children:"Previous"})}),[...Array(Math.min(5,a.pages))].map((s,t)=>{const i=t+1;return e.jsx("li",{className:`page-item ${a.page===i?"active":""}`,children:e.jsx("button",{className:"page-link",onClick:()=>x(i),children:i})},t)}),e.jsx("li",{className:`page-item ${a.page===a.pages?"disabled":""}`,children:e.jsx("button",{className:"page-link",onClick:()=>x(a.page+1),disabled:a.page===a.pages,children:"Next"})})]})})]})]})})})})]})};export{de as default};
